## 0007 - Add Quantity to Expenses (UI, DB Migration, Chat/Gemini)

### Context
Add quantity to the expenses as a new input field. This should be updated in the UI, it should be updated in the database with a new migration file, and it should be updated in the `chat.js` file in the Gemini instruction.

Keep the change minimal, compatible with existing data, and aligned with centralized Supabase access via `src/lib/supabase.js`.

---

### Files To Modify
- `src/components/AddExpenseModal.vue`
  - Add a numeric input for quantity (default 1, integer ≥ 1).
  - Validate alongside item and cost; include in emitted payload `{ item, cost, quantity, date }`.

- `src/components/EditExpenseModal.vue`
  - Add a numeric input for quantity (default 1).
  - Pre-populate from `expense.quantity` (fallback to 1 if absent).
  - Include `quantity` in emitted payload on Save.

- `src/components/DayView.vue`
  - When saving new expenses, pass `quantity` through to `insertExpense`.
  - Render quantity in the list when `quantity > 1` (e.g., "bread ×2").
  - Totals continue summing `cost` (no change to arithmetic).

- `src/components/MonthView.vue`
  - Display quantity per row when `quantity > 1`.
  - Grouping currently strips a trailing `xN` from `item`. Keep backward compatibility by continuing to compute a base item name from either the explicit `quantity` (preferred) or any legacy `" xN"` suffix in `item`.

- `src/lib/supabase.js`
  - Update selects to include `quantity` in: `fetchExpensesByDate`, `fetchExpensesByMonth`, `insertExpense` (returning row), and `updateExpense`.
  - Update `insertExpense(userId, expense)` to accept and persist `quantity` (default to 1 if not provided) and include it in the insert payload.
  - Update `updateExpense(userId, id, expense)` to allow updating `quantity`.

- `netlify/functions/chat.js`
  - Update Gemini extraction and insertion path to persist explicit `quantity`:
    - In `tryAddFromNaturalText(...)`, keep parsing `{ name, quantity, unitPrice, total }` but insert rows as `{ item: name, quantity, cost: total, date }` (remove the legacy `" xN"` suffix from `item`).
    - Ensure any downstream selection and summaries work with the explicit `quantity` column; maintain compatibility with old rows by continuing to derive a base item name from either explicit `quantity` or legacy suffix in `item`.
  - Update any selects used in chat flows to include `quantity` where appropriate.
  - Clarify the Gemini instruction to emphasize quantity is an explicit field stored in the DB.

---

### Data Layer (DB + Migration)
- Create a new migration file: `supabase/migrations/<timestamp>_expenses_add_quantity.sql`.
  - Add column to `public.expenses`:
    - `quantity integer not null default 1 check (quantity >= 1)`.
  - Backfill strategy for legacy data (optional but recommended): For rows whose `item` ends with a quantity suffix like `" xN"`, update `quantity = N` and trim the suffix from `item`.
  - Keep existing RLS policies; they remain valid as they scope by `user_id`.

Notes:
- Existing rows should transparently read with `quantity = 1` after the migration.
- API responses should include `quantity` going forward; UI should handle its absence by defaulting to `1` to support users on older data until migration is applied.

---

### Implementation Details
1) Database
   - Run migration adding `quantity` with default and check constraint.
   - Optionally perform a one-time cleanup: parse and remove trailing `xN` from `item`, setting `quantity` accordingly.

2) Library (`src/lib/supabase.js`)
   - Extend selects to include `quantity`.
   - Accept and forward `quantity` in `insertExpense` and `updateExpense`.
   - Validate inputs at the boundary: coerce to integer, require `quantity >= 1` or throw.

3) UI
   - `AddExpenseModal.vue`: add `quantity` input; validate integer ≥ 1; include in `save` emit.
   - `EditExpenseModal.vue`: add `quantity` input bound to the loaded expense; include in Save emit.
   - `DayView.vue` / `MonthView.vue`: display `×quantity` when `quantity > 1`; keep totals based on `cost`.

4) Chat/Gemini (`netlify/functions/chat.js`)
   - Keep the "intent" and "query plan" flows unchanged.
   - In add flow (`tryAddFromNaturalText`): write `item` as the base name, persist `quantity` as a separate column, set `cost` to the line total.
   - Update any selects to include `quantity` so summaries or future features can leverage it.
   - Instruction tweak: explicitly tell Gemini that quantity is stored separately and `total = quantity * unitPrice` when possible; otherwise default to `quantity = 1` and price `0`.

---

### Acceptance
- Adding an expense via UI shows a quantity field, enforces integer ≥ 1, and saves.
- Editing an expense shows and updates quantity.
- Day and Month views display `×N` when quantity > 1; totals unchanged.
- Database has `quantity` column with default 1; existing rows behave correctly.
- Chat add from natural text stores base `item`, explicit `quantity`, and `cost = total` without embedding `xN` in `item`.

