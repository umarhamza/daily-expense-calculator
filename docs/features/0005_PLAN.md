## Settings Page: username, password, currency, and PWA install button

### Context
Add a Settings view to the existing Vue 3 + Vuetify single-view app (no router) so a signed-in user can:
- Change their username (display name)
- Change their password
- Change their currency used for displaying amounts
- Install the PWA via an explicit Install button

Persist profile preferences in a dedicated database table `public.profiles` keyed by `user_id` (references `auth.users`). Password updates use Supabase `auth.updateUser({ password })`. Currency display should be centralized and applied in `DayView` and `MonthView` (replacing the current hardcoded "D"). PWA install uses the `beforeinstallprompt` event and the existing `vite-plugin-pwa` setup.

### Files to Create
- `src/components/SettingsPage.vue`
  - Sections: Profile (display name), Security (password), Preferences (currency), PWA (install button/status)
  - Emits none; internal calls to lib functions; uses toasts for feedback

- `src/components/PwaInstall.vue`
  - Encapsulates PWA install prompt handling
  - Props none; emits optional `installed` when completed

- `src/lib/currency.js`
  - Exports `formatCurrency(amount, currencyCode)` and `getDefaultCurrency()`

### Files to Modify
- `src/App.vue`
  - Add `'settings'` to `currentView` options and switch
  - Render `SettingsPage` when selected
  - Keep auth/session handling in place

- `src/components/BottomNav.vue`
  - Add a fourth navigation button `Settings` (e.g., icon `mdi-cog`), emitting `navigate('settings')`

- `src/components/DayView.vue`
  - Replace hardcoded currency prefix with `formatCurrency(e.cost, currency)`
  - Accept `currency` as a prop from `App.vue` or import a reactive settings composable (see below)

- `src/components/MonthView.vue`
  - Replace hardcoded currency prefix in list and totals with `formatCurrency(...)`
  - Accept `currency` prop or import composable

- `src/lib/supabase.js`
  - Add small, focused helpers:
    - `getCurrentUser()` → returns `supabase.auth.getUser()` data
    - `getProfile(userId)` → `select * from public.profiles where user_id = :userId limit 1`
    - `updateProfile(userId, partial)` → `update public.profiles set ... where user_id = :userId returning *`
    - `updateUserPassword(newPassword)` → `supabase.auth.updateUser({ password: newPassword })`

### Data Layer (DB + Migration)
- Create `public.profiles` table with RLS and policies, and auto-insert on new user signup.
- Columns:
  - `user_id uuid primary key references auth.users(id) on delete cascade`
  - `display_name text null check (char_length(display_name) between 1 and 64)`
  - `currency text not null default 'USD' check (char_length(currency) = 3)`
  - `created_at timestamptz not null default now()`
  - `updated_at timestamptz not null default now()`
- RLS and Policies:
  - Enable RLS on `public.profiles`
  - `select` policy: `auth.uid() = user_id`
  - `update` policy: `auth.uid() = user_id`
  - (No direct `insert` policy needed; rows are inserted by trigger as `postgres`)
- Triggers/Functions:
  - `public.set_updated_at()` BEFORE UPDATE trigger to maintain `updated_at`
  - `public.handle_new_user()` AFTER INSERT ON `auth.users` to insert a `profiles` row with default values
  - Ensure `handle_new_user` function is `security definer` and owned by `postgres` so it can insert regardless of RLS
- Migration file: `supabase/migrations/<timestamp>_profiles.sql` implementing the above

### App State
- On sign-in, fetch the `profiles` row to initialize Settings UI. Fallback to `USD` in UI if unset while data loads.
- Mirror `currency` to `localStorage` to avoid flicker before profile fetch; the database remains the source of truth.

### Algorithms / Flows
- Username update (display name)
  1) User enters a non-empty `display_name` (trim, length 1–64) and submits
  2) Call `updateProfile(userId, { display_name })`
  3) On success: update local state and `localStorage`; show success toast
  4) On error: show error toast; do not silently swallow

- Password update
  1) User enters `newPassword` and `confirmPassword` (min 6 chars, match)
  2) Call `updateUserPassword(newPassword)`
  3) On success: show success toast (warn that re-login may be required by Supabase policies)
  4) On error: show error toast

- Currency change
  1) User selects currency code from a vetted list (e.g., `USD`, `EUR`, `GBP`, `JPY`, `AUD`, `CAD`)
  2) Call `updateProfile(userId, { currency })`
  3) Persist selected currency to `localStorage` for faster next boot
  4) Re-render amounts by using `formatCurrency` wherever amounts are displayed

- Currency formatting (`src/lib/currency.js`)
  - `formatCurrency(amount: number, currencyCode: string): string`
    - Guard against non-finite numbers and fallback to 0.00
    - Use `Intl.NumberFormat(undefined, { style: 'currency', currency: currencyCode || 'USD', maximumFractionDigits: 2 })`
  - `getDefaultCurrency(): string` → read from `localStorage` or `'USD'`

- PWA install button (`src/components/PwaInstall.vue`)
  1) Listen once for `window.beforeinstallprompt` → store the event in a ref; set `canInstall = true`
  2) If `canInstall`, show an Install button; on click, call `event.prompt()`, await `userChoice`
  3) If accepted → emit `installed` and hide the button; if dismissed → keep button visible
  4) Also listen to `window.appinstalled` → hide button and show success toast
  5) If already installed (display-mode: standalone), hide button

### UI Details (Vuetify)
- `src/components/SettingsPage.vue`
  - Title: Settings
  - Profile section: `v-text-field` (Display Name), Save button
  - Security section: `v-text-field` (New Password), `v-text-field` (Confirm), Update button
  - Preferences section: `v-select` (Currency list)
  - PWA section: include `<PwaInstall />` component
  - Use existing toast helpers from `src/lib/toast.js`

### Integration Details
- `src/App.vue`
  - Maintain `session` and `userId` as-is
  - On session load, fetch `profiles` row (`display_name`, `currency`) and provide `currency` down to `DayView` and `MonthView` via prop
  - Add handling in `handleNavigate('settings')`

- `src/components/BottomNav.vue`
  - Add settings tab/button (e.g., order: Day, Month, Chat, Settings)

- `src/components/DayView.vue` and `src/components/MonthView.vue`
  - Add `props: { currency: String }`
  - Replace occurrences of amount rendering (currently `D{{ e.cost.toFixed(2) }}`) with `formatCurrency(e.cost, props.currency)`

### Validation and Errors
- Display name: trim, non-empty, max length 64
- Password: min length 6, must match confirmation
- Currency: restrict to known codes; default `USD` when missing/invalid
- All lib calls must throw on error; UI catches and shows toast via `showErrorToast`

### Notes and Constraints
- No router is introduced; the Settings view is toggled like existing views
- Keep Supabase interactions inside `src/lib/supabase.js`
- Do not log secrets; do not persist Supabase keys
- Avoid broad refactors; keep edits minimal and localized

### Out of Scope
- Changing auth email address
- Profile avatar uploads
- Server-side validation beyond Supabase auth constraints

- ### Acceptance Checks (developer)
- Signed-in user can update display name; subsequent refresh shows updated value (profiles)
- Password update succeeds with valid input and shows feedback
- Currency selection updates and persists; amounts in Day and Month views reflect formatting
- Install button appears when the app is installable; clicking prompts install and then hides after installation
