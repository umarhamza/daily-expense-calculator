# Feature Plan — Conversational Expense Chatbot with Confirmation

## Context
The assistant currently feels too restricted. We want it to remain scoped and safe, but be clearly aware it is a daily expense tracker and support natural, multi‑turn conversation. The bot should ask for confirmation before making changes, and, based on user responses, either perform CRUD operations or answer spending questions, including calculating totals for specific items and periods.

## Scope
Expand the chat experience to be conversational and domain‑aware while retaining guardrails:
- Domain primer: consistently remind the model it is a daily expense tracker.
- Conversation: preserve multi‑turn context and let users ask follow‑ups.
- Confirmation: require user confirmation before ADD/MODIFY/DELETE.
- Queries: answer spend questions (totals by item, period, comparisons) directly.
- Keep existing contracts; implement minimal backend and data helpers to support totals.

Out of scope: authentication changes, provider swaps, streaming changes, large UI redesigns.

## Files to create/update
- netlify/functions/chat.js
  - Inject a concise system primer that frames scope: “daily expense tracker, safe, helpful, conversational, confirm before mutations.”
  - Keep existing intent router; extend QUERY handling to include totals by item/time windows and simple summaries.
  - Reuse existing confirmation flow: return `{ confirmationRequired, proposal, chatId }` for ADD/MODIFY/DELETE and commit on `confirm`.
  - Use DB chat history (already present) to keep responses context‑aware.
- src/lib/supabase.js
  - Add aggregate helpers (named exports):
    - `getTotalForItem(userId, item, startDate?, endDate?)` → sum of `cost * quantity` over optional date range.
    - `getTotalForPeriod(userId, startDate, endDate)` → total spend in date window.
    - `getTopItems(userId, startDate?, endDate?, limit = 5)` → top items by spend.
  - Follow existing pattern: return `{ data, error }`; validate inputs.
- src/components/ChatPage.vue and/or src/components/ChatModal.vue
  - Keep current confirmation UI using `pendingProposal` and `confirmProposal`.
  - Update empty/first message and helper copy to emphasize conversational expense scope (e.g., “Ask me to add an expense or total your coffee spend this month”).
- docs/features/0003_PLAN.md (this file)

## API and flow changes
Entry: `POST /.netlify/functions/chat`
- Headers: `Authorization: Bearer <access_token>` (unchanged).
- Body: `{ question: string, chatId?: string, title?: string, history?: Array<{role,content}>, confirm?: {...} }` (unchanged).
- Behavior adjustments:
  1) Maintain chat creation/persistence and history loading.
  2) On `confirm`, commit the corresponding proposal (ADD | MODIFY | DELETE) as today.
  3) On `QUERY`, route sub‑intents:
     - Totals for an item: parse item and optional window (e.g., “this week”, “last month”, custom dates); use aggregate helpers and reply with the number and a brief explanation.
     - Totals for a period: compute overall spend for a date range.
     - Quick summaries: top items for a recent period.
  4) For ambiguous or missing timeframes, default to reasonable windows and state assumptions (e.g., “Assuming this month”).

Return shapes (unchanged): `{ answer, chatId, messageId?, confirmationRequired?, proposal?, added?, updated?, deleted? }`.

## Prompt construction and guardrails
- System primer (prepend):
  - “You are a daily expense tracker assistant. Stay within tracking and reporting expenses. Be concise, friendly, and conversational. Ask the user to confirm before you add, modify, or delete any expense. For questions, answer directly with totals and short context. If the user asks outside scope, briefly redirect to expense tracking.”
- History: include the last N messages (already implemented) to sustain multi‑turn conversation.
- Style: short paragraphs, clear numbers, currency from profile if available; otherwise do not guess currency symbols.
- Safety: avoid speculative actions; always request confirmation for mutations.

## UI behaviors
- Conversation: keep existing message list, composer, and “Thinking…” placeholder.
- Confirmation: when `{ confirmationRequired, proposal }` is returned, show the model’s summary and ask the user to confirm or cancel; commit on user confirmation using the existing `confirm` flow.
- Answers: for QUERY responses (e.g., totals), show direct numeric results plus a one‑line hint for a next step (e.g., “Want to see a breakdown by item?”).
- Empty state: revise copy to domain‑aware suggestions:
  - “Add coffee 2 at 4.50 today”
  - “Total spent on groceries this month”
  - “Compare this week vs last week”

## Data access (Supabase)
New helpers in `src/lib/supabase.js`:
- `getTotalForItem(userId, item, startDate?, endDate?)`
  - Validates `item` and optional ISO dates; sums `cost * quantity` across `expenses` for user.
- `getTotalForPeriod(userId, startDate, endDate)`
  - Validates ISO dates; sums `cost * quantity` across the window.
- `getTopItems(userId, startDate?, endDate?, limit = 5)`
  - Groups by `item`, orders by total desc; returns top items with totals.

Notes:
- Use parameterized filters; never expose raw SQL or secrets.
- Return `{ data, error }`; do not throw in `src/lib`.

## Edge cases and constraints
- Missing auth → 401 (unchanged).
- Unknown `chatId` → 404/403 as today.
- Ambiguous timeframes or items → ask a brief clarification; for simple cases, apply defaults (e.g., today/this month) and state them.
- Token budget: retain history cap.
- Network/DB errors: respond with friendly error text; keep confirmation state consistent.

## Implementation phases (small, incremental)
- Phase A — Prompt and intent
  - Add system primer and clarify QUERY routing for totals and summaries.
- Phase B — Aggregates
  - Implement `getTotalForItem`, `getTotalForPeriod`, `getTopItems` in `src/lib/supabase.js`.
- Phase C — API wiring
  - Call aggregate helpers from `netlify/functions/chat.js` under QUERY sub‑intents; keep return shape stable.
- Phase D — UI copy tweaks
  - Update initial assistant message and empty‑state suggestions to highlight conversational expense use cases.

## Relevant existing code references
- `netlify/functions/chat.js` — intent routing, confirmation proposals, chat persistence.
- `src/lib/supabase.js` — existing CRUD helpers and chat helpers; add aggregate helpers here.
- `src/components/ChatPage.vue`, `src/components/ChatModal.vue` — confirmation flow, message list, composer.
- `docs/features/0001_PLAN.md`, `0002_PLAN.md` — prior plans’ structure and conventions.

