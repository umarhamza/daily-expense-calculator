# Feature Plan: Ensure mobile install from `PwaInstall` button

Context: The requirement is: "the PwaInstall Component should install on mobile when the button is clicked". Today, the install prompt relies on the `beforeinstallprompt` (BIP) event being captured after the component mounts. If BIP fires earlier (common) the component never sees it, the button may not show, and the install action cannot proceed. iOS Safari does not support BIP, so we must provide guidance when programmatic install is unavailable.

## Relevant files
- `src/components/PwaInstall.vue` — install CTA, state, and event handling
- `src/main.js` — earliest app entry to register global listeners
- (Optional) `src/lib/pwa-install.js` — small singleton store for the deferred BIP event (if preferred over a window-scoped variable)
- `vite.config.js` — PWA config (already correct: manifest, display, icons)
- `index.html` — manifest link present

## Technical changes
1) Capture BIP globally as early as possible
   - Add a top-level `window.addEventListener('beforeinstallprompt', ...)` in `src/main.js` before app mount.
   - `preventDefault()` and cache the event in a global store (either a tiny `src/lib/pwa-install.js` module or `window.__deferredBip`).
   - Dispatch a `CustomEvent('pwa:can-install')` on `window` after caching so late-mounted components can react.
   - Also add a `window.addEventListener('appinstalled', ...)` global hook to clear the cached event.

2) Make the CTA visible and actionable on mobile even if BIP wasn’t yet seen
   - In `PwaInstall.vue`, compute `isMobile`, `isIOS`, and `isStandalone` (existing logic is fine).
   - Always render the Install button when `isMobile && !isStandalone`.
   - On mount, read the cached global BIP event; if present, set `canInstall = true`.
   - Subscribe to `window` `pwa:can-install` to flip `canInstall = true` if the event arrives later.

3) Click behavior for install
   - If `canInstall` and a cached BIP event exists: call `prompt()`, await `userChoice`, and handle accepted/declined.
   - If no BIP event (unsupported or not yet eligible):
     - iOS: show inline guidance like "On iOS, use Share → Add to Home Screen." (component already has fallback messaging; ensure it shows on click when BIP is absent).
     - Non-iOS mobile: show a brief message such as "Install not available yet in this browser. Try again later." (existing `infoMessage` can be reused).

4) Installed handling
   - On `appinstalled`, clear cached BIP event, hide CTA, and surface a success toast (existing behavior in `PwaInstall.vue` can be kept; add global clear to avoid stale cache).

## File-level edits (no code here, just targets and intent)
- `src/main.js`
  - Add global listeners for `beforeinstallprompt` and `appinstalled` before `createApp(...).mount(...)`.
  - Cache BIP event and emit `pwa:can-install`.

- `src/lib/pwa-install.js` (optional, preferred over window globals)
  - Minimal singleton with `setDeferredPrompt(e)`, `getDeferredPrompt()`, `clearDeferredPrompt()`.

- `src/components/PwaInstall.vue`
  - Read cached BIP on mount; set `canInstall` accordingly.
  - Listen for `pwa:can-install` and update state.
  - Render Install button whenever `isMobile && !isStandalone`.
  - On click: prompt if available; otherwise show iOS/Android guidance via existing `infoMessage` and toasts.
  - Keep existing `appinstalled` handling; add a call to clear the cached BIP.

## Notes & constraints
- Android/Chrome: BIP-driven programmatic install is supported; this plan ensures we don’t miss the event and the button consistently triggers the native prompt.
- iOS/Safari: Programmatic install is not supported; the button will show and, on click, display native instructions to add to Home Screen.
- No DB or API changes required.

## Acceptance criteria
- On Android/Chrome, visiting the app (any route), navigating to Settings, and clicking Install reliably opens the native install prompt even if BIP fired before opening Settings.
- After installation, the app surfaces a success state and hides the CTA.
- On iOS/Safari, the Install button is visible; clicking shows clear A2HS guidance.

